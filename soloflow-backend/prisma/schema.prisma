generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id               String            @id @default(uuid())
  name             String            @unique
  cnpj             String            @unique
  email            String?
  phone            String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  processInstances ProcessInstance[]
  processTypes     ProcessType[]
  profiles         profiles[]
  sectors          Sector[]
  userCompanies    UserCompany[]
  user_profiles    user_profiles[]
  auditLogs        AuditLog[]

  @@map("companies")
}

model User {
  id                    String                 @id @default(uuid())
  name                  String
  email                 String                 @unique
  password              String
  isActive              Boolean                @default(true)
  cpf                   String?                // CPF criptografado para LGPD
  cpfHash               String?                // Hash do CPF para busca
  phone                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  createdProcesses      ProcessInstance[]
  signatureRecords      SignatureRecord[]      @relation("SignatureRecords")
  signatureRequirements SignatureRequirement[] @relation("UserSignatureRequirements")
  stepAssignments       StepAssignment[]       @relation("UserStepAssignments")
  executedSteps         StepExecution[]
  userCompanies         UserCompany[]
  user_profiles         user_profiles[]
  refreshTokens         RefreshToken[]
  auditLogs             AuditLog[]
  // Sub-tarefas
  subTaskTemplates      SubTaskTemplate[]      @relation("SubTaskTemplateUser")
  subTaskExecutions     SubTask[]              @relation("SubTaskExecutor")
  // LGPD
  consents              UserConsent[]          @relation("UserConsents")
  deletionRequests      DataDeletionRequest[]  @relation("DataDeletionRequests")

  @@map("users")
}

// Modelo para Refresh Tokens - Segurança aprimorada
model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  expiresAt DateTime
  isRevoked Boolean   @default(false)
  userAgent String?
  ipAddress String?
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Modelo para Auditoria - Rastreamento de ações críticas
model AuditLog {
  id         String   @id @default(uuid())
  action     String // LOGIN, LOGOUT, CREATE_USER, DELETE_USER, CHANGE_PERMISSIONS, etc
  resource   String // users, companies, processes, profiles, etc
  resourceId String? // ID do recurso afetado
  details    Json? // Dados adicionais (antes/depois, campos alterados, etc)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([companyId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserCompany {
  id             String   @id @default(uuid())
  role           UserRole @default(USER)
  isDefault      Boolean  @default(false)
  lastAccessedAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String
  companyId      String
  sectorId       String?
  sector         Sector?  @relation(fields: [sectorId], references: [id])
  company        Company  @relation(fields: [companyId], references: [id])
  user           User     @relation(fields: [userId], references: [id])

  @@unique([userId, companyId])
  @@map("user_companies")
}

model Sector {
  id                    String                 @id @default(uuid())
  name                  String
  description           String?
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  companyId             String
  company               Company                @relation(fields: [companyId], references: [id])
  signatureRequirements SignatureRequirement[] @relation("SectorSignatureRequirements")
  stepAssignments       StepAssignment[]       @relation("SectorStepAssignments")
  stepExecutions        StepExecution[]
  userCompanies         UserCompany[]
  // Sub-tarefas
  subTaskTemplates      SubTaskTemplate[]      @relation("SubTaskTemplateSector")

  @@unique([companyId, name])
  @@map("sectors")
}

model ProcessType {
  id                       String                  @id @default(uuid())
  name                     String
  description              String?
  isActive                 Boolean                 @default(true)
  isChildProcessOnly       Boolean                 @default(false) // Se true, só pode ser usado como subprocesso
  allowSubProcesses        Boolean                 @default(true)  // Permite criar subprocessos
  allowSubTasks            Boolean                 @default(true)  // Permite criar subtarefas nas etapas
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  companyId                String
  // JSON array de IDs de ProcessTypes permitidos como sub-processos
  allowedChildProcessTypes Json?
  versions                 ProcessTypeVersion[]
  company                  Company                 @relation(fields: [companyId], references: [id])
  profile_process_types    profile_process_types[]
  // Sub-processos: configurações que usam este tipo
  childProcessConfigs      ChildProcessConfig[]    @relation("ChildProcessType")

  @@unique([companyId, name])
  @@map("process_types")
}

model ProcessTypeVersion {
  id              String             @id @default(uuid())
  version         Int
  versionLabel    String?
  description     String?
  isActive        Boolean            @default(true)
  isDraft         Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  publishedAt     DateTime?
  changelog       String?
  processTypeId   String
  metadata        Json?
  formFields      FormFieldVersion[]
  instances       ProcessInstance[]
  processType     ProcessType        @relation(fields: [processTypeId], references: [id], onDelete: Cascade)
  steps           StepVersion[]

  @@unique([processTypeId, version])
  @@map("process_type_versions")
}

model FormFieldVersion {
  id                   String             @id @default(uuid())
  name                 String
  label                String
  type                 FieldType
  placeholder          String?
  required             Boolean            @default(false)
  order                Int
  options              Json?
  validations          Json?
  defaultValue         String?
  helpText             String?
  tableColumns         Json?              // Colunas para campos do tipo TABLE
  minRows              Int?               // Mínimo de linhas para tabela
  maxRows              Int?               // Máximo de linhas para tabela
  createdAt            DateTime           @default(now())
  processTypeVersionId String
  processTypeVersion   ProcessTypeVersion @relation(fields: [processTypeVersionId], references: [id], onDelete: Cascade)

  @@unique([processTypeVersionId, order])
  @@map("form_field_versions")
}

model StepVersion {
  id                    String                 @id @default(uuid())
  name                  String
  description           String?
  instructions          String?
  slaHours              Int?
  slaDays               Int?
  type                  StepType               @default(INPUT)
  order                 Int
  allowAttachment       Boolean                @default(false)
  requiresSignature     Boolean                @default(false)
  requireAttachment     Boolean                @default(false)
  minAttachments        Int?
  maxAttachments        Int?
  allowedFileTypes      Json?
  conditions            Json?
  assignedToCreator     Boolean                @default(false)
  reuseData             Json?                  // Configuração de reutilização de dados de etapas anteriores (REVIEW)
  reviewSettings        Json?                  // Configurações do campo de notas de revisão (REVIEW)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  processTypeVersionId  String
  signatureRequirements SignatureRequirement[]
  assignments           StepAssignment[]
  executions            StepExecution[]
  processTypeVersion    ProcessTypeVersion     @relation(fields: [processTypeVersionId], references: [id], onDelete: Cascade)
  // Sub-processos: configurações que usam esta etapa como gatilho
  triggerChildConfigs   ChildProcessConfig[]   @relation("TriggerStepConfigs")
  // Sub-tarefas: templates de sub-tarefas desta etapa
  subTaskTemplates      SubTaskTemplate[]      @relation("StepSubTaskTemplates")

  @@unique([processTypeVersionId, order])
  @@map("step_versions")
}

model StepAssignment {
  id                String         @id @default(uuid())
  type              AssignmentType
  priority          Int            @default(1)
  isActive          Boolean        @default(true)
  conditions        Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  stepVersionId     String
  userId            String?
  sectorId          String?
  dynamicRole       DynamicRole?
  conditionalConfig Json?
  sector            Sector?        @relation("SectorStepAssignments", fields: [sectorId], references: [id])
  user              User?          @relation("UserStepAssignments", fields: [userId], references: [id])
  stepVersion       StepVersion    @relation(fields: [stepVersionId], references: [id], onDelete: Cascade)

  @@map("step_assignments")
}

model ProcessInstance {
  id                   String                 @id @default(uuid())
  code                 String                 @unique
  title                String?
  description          String?
  status               ProcessStatus          @default(IN_PROGRESS)
  currentStepOrder     Int                    @default(1)
  formData             Json?
  metadata             Json?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  completedAt          DateTime?
  processTypeVersionId String
  createdById          String
  companyId            String
  company              Company                @relation(fields: [companyId], references: [id])
  createdBy            User                   @relation(fields: [createdById], references: [id])
  processTypeVersion   ProcessTypeVersion     @relation(fields: [processTypeVersionId], references: [id])
  stepExecutions       StepExecution[]
  // Sub-processos: configurações deste processo
  childProcessConfigs  ChildProcessConfig[]   @relation("ProcessChildConfigs")
  // Sub-processos: processos filhos deste processo
  childProcesses       ChildProcessInstance[] @relation("ParentChildProcesses")
  // Se este processo é filho de outro
  parentRelation       ChildProcessInstance?  @relation("ChildProcessRelation")

  @@map("process_instances")
}

model StepExecution {
  id                    String                 @id @default(uuid())
  status                StepExecutionStatus    @default(PENDING)
  action                String?
  dueAt                 DateTime?
  comment               String?
  metadata              Json?
  signedAt              DateTime?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  completedAt           DateTime?
  processInstanceId     String
  stepVersionId         String
  executorId            String?
  sectorId              String?
  attachments           Attachment[]
  signatureRecords      SignatureRecord[]
  sector                Sector?                @relation(fields: [sectorId], references: [id])
  executor              User?                  @relation(fields: [executorId], references: [id])
  stepVersion           StepVersion            @relation(fields: [stepVersionId], references: [id])
  processInstance       ProcessInstance        @relation(fields: [processInstanceId], references: [id])
  // Sub-processos disparados por esta etapa
  triggeredChildProcesses ChildProcessInstance[] @relation("OriginStepChildProcesses")
  // Sub-tarefas desta etapa
  subTasks              SubTask[]              @relation("StepSubTasks")

  @@map("step_executions")
}

model Attachment {
  id                    String                 @id @default(uuid())
  filename              String
  originalName          String
  mimeType              String
  size                  Int
  path                  String
  isSigned              Boolean                @default(false)
  signedPath            String?
  signatureData         String?
  createdAt             DateTime               @default(now())
  stepExecutionId       String
  stepExecution         StepExecution          @relation(fields: [stepExecutionId], references: [id], onDelete: Cascade)
  signatureRecords      SignatureRecord[]
  signatureRequirements SignatureRequirement[]

  @@map("attachments")
}

model SignatureRequirement {
  id               String            @id @default(uuid())
  order            Int
  type             String            @default("SEQUENTIAL")
  isRequired       Boolean           @default(true)
  description      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  stepVersionId    String
  attachmentId     String?
  userId           String?
  sectorId         String?
  signatureRecords SignatureRecord[]
  sector           Sector?           @relation("SectorSignatureRequirements", fields: [sectorId], references: [id])
  user             User?             @relation("UserSignatureRequirements", fields: [userId], references: [id])
  attachment       Attachment?       @relation(fields: [attachmentId], references: [id], onDelete: Cascade)
  stepVersion      StepVersion       @relation(fields: [stepVersionId], references: [id], onDelete: Cascade)

  @@unique([stepVersionId, attachmentId, order])
  @@map("signature_requirements")
}

model SignatureRecord {
  id              String               @id @default(uuid())
  status          String               @default("PENDING")
  signerName      String
  signerCPF       String?
  signerEmail     String
  signedAt        DateTime?
  signatureHash   String?
  documentHash    String?
  signatureToken  String?
  signatureReason String?
  ipAddress       String?
  userAgent       String?
  metadata        Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  requirementId   String
  attachmentId    String
  signerId        String
  stepExecutionId String
  stepExecution   StepExecution        @relation(fields: [stepExecutionId], references: [id], onDelete: Cascade)
  signer          User                 @relation("SignatureRecords", fields: [signerId], references: [id])
  attachment      Attachment           @relation(fields: [attachmentId], references: [id], onDelete: Cascade)
  requirement     SignatureRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@map("signature_records")
}

model profile_permissions {
  id        String   @id
  resource  String
  action    String
  scope     Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  profileId String
  profiles  profiles @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, resource, action])
}

model profile_process_types {
  id            String      @id
  canView       Boolean     @default(true)
  canCreate     Boolean     @default(false)
  canExecute    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  profileId     String
  processTypeId String
  process_types ProcessType @relation(fields: [processTypeId], references: [id], onDelete: Cascade)
  profiles      profiles    @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, processTypeId])
}

model profiles {
  id                    String                  @id
  name                  String
  description           String?
  isDefault             Boolean                 @default(false)
  isActive              Boolean                 @default(true)
  companyId             String?
  parentProfileId       String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  profile_permissions   profile_permissions[]
  profile_process_types profile_process_types[]
  companies             Company?                @relation(fields: [companyId], references: [id])
  user_profiles         user_profiles[]
  parentProfile         profiles?               @relation("ProfileHierarchy", fields: [parentProfileId], references: [id])
  childProfiles         profiles[]              @relation("ProfileHierarchy")

  @@unique([companyId, name])
  @@index([parentProfileId])
}

model user_profiles {
  id         String   @id
  assignedAt DateTime @default(now())
  assignedBy String?
  userId     String
  companyId  String
  profileId  String
  profiles   profiles @relation(fields: [profileId], references: [id], onDelete: Cascade)
  companies  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId, profileId])
  @@index([userId, companyId])
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

enum StepType {
  INPUT
  APPROVAL
  UPLOAD
  REVIEW
  SIGNATURE
}

enum ProcessStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REJECTED
}

enum StepExecutionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  SKIPPED
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  EMAIL
  CPF
  CNPJ
  PHONE
  DROPDOWN
  CHECKBOX
  TEXTAREA
  CURRENCY
  FILE
  TABLE
}

enum AssignmentType {
  USER
  SECTOR
  ROLE
  CONDITIONAL
}

enum DynamicRole {
  PROCESS_CREATOR
  SECTOR_MANAGER
  COMPANY_ADMIN
  PREVIOUS_EXECUTOR
  DATA_OWNER
}

// ════════════════════════════════════════════════════════════════════════════════
// SUB-PROCESSOS E SUB-TAREFAS
// ════════════════════════════════════════════════════════════════════════════════

// Modo de criação do sub-processo
enum ChildProcessMode {
  MANUAL    // Disparado por botão/etapa
  RECURRENT // Intervalos automáticos
  SCHEDULED // Data/condição específica
}

// Status do sub-processo
enum ChildProcessStatus {
  PENDING   // Agendado, ainda não criado
  ACTIVE    // Em execução
  COMPLETED // Concluído com sucesso
  CANCELLED // Cancelado
  FAILED    // Falhou
}

// Modo de execução das sub-tarefas
enum SubTaskExecutionMode {
  SEQUENTIAL // Uma após a outra
  PARALLEL   // Todas ao mesmo tempo
}

// Tipo de atribuição de sub-tarefa
enum SubTaskAssignmentType {
  INHERIT // Herda da etapa pai
  USER    // Usuário específico
  SECTOR  // Setor específico
  CREATOR // Criador do processo
}

// Status da sub-tarefa
enum SubTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  CANCELLED
}

// Configuração de sub-processos vinculada ao ProcessInstance
model ChildProcessConfig {
  id                   String           @id @default(uuid())
  name                 String           // Nome descritivo da configuração

  // Processo pai que terá os sub-processos
  processInstanceId    String
  processInstance      ProcessInstance  @relation("ProcessChildConfigs", fields: [processInstanceId], references: [id], onDelete: Cascade)

  // Tipo de sub-processo a criar
  childProcessTypeId   String
  childProcessType     ProcessType      @relation("ChildProcessType", fields: [childProcessTypeId], references: [id])

  // Modalidade do sub-processo
  mode                 ChildProcessMode

  // Para MANUAL: vinculado a uma etapa (opcional - pode ser criado por botão)
  triggerStepVersionId String?
  triggerStepVersion   StepVersion?     @relation("TriggerStepConfigs", fields: [triggerStepVersionId], references: [id])

  // Para RECORRENTE: configuração de frequência
  // { frequency, interval, dayOfMonth, dayOfWeek, time, maxRuns, startDate, endDate }
  recurrence           Json?

  // Configurações comuns
  waitForCompletion    Boolean          @default(false)  // Bloquear pai até filho completar?
  autoStart            Boolean          @default(true)   // Iniciar automaticamente?

  // Mapeamento de dados entre pai e filho
  inputDataMapping     Json?            // { "campoPai": "campoFilho" }

  // Controle de execução
  isActive             Boolean          @default(true)
  nextRunAt            DateTime?
  lastRunAt            DateTime?
  runCount             Int              @default(0)

  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  // Processos gerados por esta configuração
  generatedProcesses   ChildProcessInstance[]

  @@map("child_process_configs")
}

// Registro de cada sub-processo gerado
model ChildProcessInstance {
  id                      String              @id @default(uuid())

  // Configuração que gerou este sub-processo (opcional para criações manuais diretas)
  configId                String?
  config                  ChildProcessConfig? @relation(fields: [configId], references: [id], onDelete: SetNull)

  // Processo pai
  parentProcessInstanceId String
  parentProcessInstance   ProcessInstance     @relation("ParentChildProcesses", fields: [parentProcessInstanceId], references: [id], onDelete: Cascade)

  // Processo filho gerado
  childProcessInstanceId  String              @unique
  childProcessInstance    ProcessInstance     @relation("ChildProcessRelation", fields: [childProcessInstanceId], references: [id], onDelete: Cascade)

  // Para MANUAL: qual etapa disparou (se aplicável)
  originStepExecutionId   String?
  originStepExecution     StepExecution?      @relation("OriginStepChildProcesses", fields: [originStepExecutionId], references: [id])

  // Para RECURRENT: controle de execução
  runNumber               Int?                // 1, 2, 3... (mês 1, mês 2)

  // Status do relacionamento
  status                  ChildProcessStatus  @default(ACTIVE)

  scheduledFor            DateTime?           // Quando deveria executar (para agendados)
  createdAt               DateTime            @default(now())
  completedAt             DateTime?

  @@map("child_process_instances")
}

// Template de sub-tarefa (configuração na etapa)
model SubTaskTemplate {
  id                 String                @id @default(uuid())

  // Etapa que contém as sub-tarefas
  stepVersionId      String
  stepVersion        StepVersion           @relation("StepSubTaskTemplates", fields: [stepVersionId], references: [id], onDelete: Cascade)

  // Informações
  name               String
  description        String?
  instructions       String?
  order              Int

  // Modo de execução
  executionMode      SubTaskExecutionMode  @default(PARALLEL)

  // Responsável
  assignmentType     SubTaskAssignmentType @default(INHERIT)
  assignedToUserId   String?
  assignedToUser     User?                 @relation("SubTaskTemplateUser", fields: [assignedToUserId], references: [id])
  assignedToSectorId String?
  assignedToSector   Sector?               @relation("SubTaskTemplateSector", fields: [assignedToSectorId], references: [id])

  // SLA
  slaHours           Int?
  slaDays            Int?

  // Configurações
  isRequired         Boolean               @default(true)
  allowAttachment    Boolean               @default(false)

  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  // Execuções desta template
  executions         SubTask[]

  @@unique([stepVersionId, order])
  @@map("sub_task_templates")
}

// Execução de sub-tarefa
model SubTask {
  id                String          @id @default(uuid())

  // Etapa em execução
  stepExecutionId   String
  stepExecution     StepExecution   @relation("StepSubTasks", fields: [stepExecutionId], references: [id], onDelete: Cascade)

  // Template da sub-tarefa
  subTaskTemplateId String
  subTaskTemplate   SubTaskTemplate @relation(fields: [subTaskTemplateId], references: [id])

  // Status
  status            SubTaskStatus   @default(PENDING)

  // Executor
  executorId        String?
  executor          User?           @relation("SubTaskExecutor", fields: [executorId], references: [id])

  // Dados de execução
  comment           String?
  dueAt             DateTime?

  // Anexo
  attachmentPath    String?
  attachmentName    String?
  attachmentSize    Int?            // Tamanho do arquivo em bytes
  attachmentMimeType String?        // Tipo MIME do arquivo
  requireSignature  Boolean         @default(false)
  signatureType     String?         // SEQUENTIAL ou PARALLEL
  signers           String?         // JSON array de IDs de usuários
  signatures        String?         // JSON array de assinaturas realizadas

  startedAt         DateTime?
  completedAt       DateTime?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("sub_tasks")
}

// ════════════════════════════════════════════════════════════════════════════════
// LGPD - CONFORMIDADE COM A LEI GERAL DE PROTEÇÃO DE DADOS
// ════════════════════════════════════════════════════════════════════════════════

// Tipo de consentimento
enum ConsentType {
  PRIVACY_POLICY      // Política de Privacidade
  TERMS_OF_USE        // Termos de Uso
  DATA_PROCESSING     // Processamento de Dados
  MARKETING           // Comunicações de Marketing
  COOKIES             // Uso de Cookies
}

// Registro de consentimento do usuário (Art. 7 e 8 da LGPD)
model UserConsent {
  id              String      @id @default(uuid())

  userId          String
  user            User        @relation("UserConsents", fields: [userId], references: [id], onDelete: Cascade)

  consentType     ConsentType
  accepted        Boolean     @default(false)
  version         String      // Versão do documento aceito (ex: "1.0", "2.0")

  // Dados de rastreabilidade
  acceptedAt      DateTime?
  revokedAt       DateTime?
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([userId, consentType])
  @@index([userId])
  @@index([consentType])
  @@map("user_consents")
}

// Política de retenção de dados (Art. 16 da LGPD)
model DataRetentionPolicy {
  id              String    @id @default(uuid())

  entityType      String    // USER, PROCESS, AUDITLOG, ATTACHMENT, etc.
  retentionDays   Int       // Número de dias para retenção
  description     String?   // Descrição da política

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([entityType])
  @@map("data_retention_policies")
}

// Solicitações de exclusão de dados (Art. 18 da LGPD - Direito ao Esquecimento)
model DataDeletionRequest {
  id              String    @id @default(uuid())

  userId          String
  user            User      @relation("DataDeletionRequests", fields: [userId], references: [id])

  reason          String?   // Motivo da solicitação
  status          String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, REJECTED

  requestedAt     DateTime  @default(now())
  processedAt     DateTime?
  processedBy     String?   // ID do admin que processou

  // Dados de rastreabilidade
  ipAddress       String?
  userAgent       String?

  // Resultado
  deletedData     Json?     // Resumo dos dados excluídos
  rejectionReason String?   // Motivo de rejeição, se aplicável

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("data_deletion_requests")
}
