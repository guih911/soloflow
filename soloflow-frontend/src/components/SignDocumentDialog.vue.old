<template>
  <v-dialog :model-value="modelValue" @update:model-value="$emit('update:modelValue', $event)" max-width="700" persistent>
    <v-card>
      <v-card-title class="d-flex align-center">
        <v-icon start color="primary">mdi-pen</v-icon>
        Assinar Documento Digitalmente
      </v-card-title>

      <v-divider />

      <v-form ref="signForm" v-model="signValid">
        <v-card-text>
          <!-- Informações do documento -->
          <v-alert type="info" variant="tonal" class="mb-4">
            <div class="text-body-2">
              <strong>Documento:</strong> {{ attachment?.originalName || 'N/A' }}
              <br />
              <strong>Tamanho:</strong> {{ formatFileSize(attachment?.size) }}
              <br />
              <strong>Etapa:</strong> {{ stepName }}
            </div>
          </v-alert>

          <!-- Seleção de certificado -->
          <v-card variant="outlined" class="mb-4">
            <v-card-title class="text-subtitle-1">
              <v-icon start>mdi-certificate</v-icon>
              Certificado Digital
            </v-card-title>
            <v-card-text>
              <v-select
                v-model="signData.certificateId"
                :items="activeCertificates"
                item-title="name"
                item-value="id"
                label="Selecione o Certificado"
                :rules="[v => !!v || 'Certificado obrigatório']"
                required
                hint="Certificado ICP-Brasil A1"
                persistent-hint
              >
                <template v-slot:item="{ item, props }">
                  <v-list-item v-bind="props">
                    <template v-slot:prepend>
                      <v-icon :color="getCertificateColor(item.raw)">
                        mdi-certificate
                      </v-icon>
                    </template>
                    <v-list-item-title>
                      {{ item.raw.name }}
                      <v-chip v-if="item.raw.isDefault" size="x-small" color="primary" class="ml-2">
                        Padrão
                      </v-chip>
                    </v-list-item-title>
                    <v-list-item-subtitle>
                      CPF: {{ item.raw.cpf || 'N/A' }} |
                      Validade: {{ formatExpirationDate(item.raw) }}
                    </v-list-item-subtitle>
                  </v-list-item>
                </template>
              </v-select>

              <div v-if="!activeCertificates.length" class="text-center py-4">
                <v-icon size="48" color="grey">mdi-certificate-outline</v-icon>
                <p class="text-body-2 mt-2">Nenhum certificado ativo encontrado</p>
                <v-btn
                  size="small"
                  color="primary"
                  prepend-icon="mdi-upload"
                  @click="$emit('upload-certificate')"
                >
                  Adicionar Certificado
                </v-btn>
              </div>
            </v-card-text>
          </v-card>

          <!-- Senha do certificado -->
          <v-text-field
            v-model="signData.certificatePassword"
            label="Senha do Certificado"
            type="password"
            prepend-icon="mdi-lock"
            :rules="[v => !!v || 'Senha obrigatória']"
            required
            hint="Digite a senha do arquivo .pfx/.p12"
            persistent-hint
            class="mb-4"
          />

          <!-- Motivo da assinatura -->
          <v-text-field
            v-model="signData.reason"
            label="Motivo da Assinatura"
            prepend-icon="mdi-text"
            hint="Ex: Aprovação de documento, Autorização, etc."
            persistent-hint
            class="mb-4"
          />

          <!-- Informações adicionais (opcionais) -->
          <v-expansion-panels variant="accordion">
            <v-expansion-panel>
              <v-expansion-panel-title>
                <v-icon start>mdi-information-outline</v-icon>
                Informações Adicionais (Opcional)
              </v-expansion-panel-title>
              <v-expansion-panel-text>
                <v-text-field
                  v-model="signData.location"
                  label="Localização"
                  prepend-icon="mdi-map-marker"
                  hint="Ex: São Paulo, Brasil"
                  persistent-hint
                  class="mb-4"
                />

                <v-text-field
                  v-model="signData.contactInfo"
                  label="Informação de Contato"
                  prepend-icon="mdi-email"
                  hint="Ex: email@exemplo.com"
                  persistent-hint
                />
              </v-expansion-panel-text>
            </v-expansion-panel>
          </v-expansion-panels>

          <!-- Termos e avisos -->
          <v-alert type="warning" variant="tonal" class="mt-4">
            <div class="text-body-2">
              <strong>Atenção:</strong>
              <ul class="mt-2">
                <li>A assinatura digital é legalmente vinculante</li>
                <li>Certifique-se de que revisou o documento antes de assinar</li>
                <li>Suas informações de assinatura serão registradas</li>
                <li>Esta ação não pode ser desfeita</li>
              </ul>
            </div>
          </v-alert>

          <v-checkbox
            v-model="acceptTerms"
            :rules="[v => !!v || 'Você deve aceitar para continuar']"
            required
            class="mt-2"
          >
            <template #label>
              <div class="text-body-2">
                Declaro que li e concordo em assinar digitalmente este documento
              </div>
            </template>
          </v-checkbox>
        </v-card-text>

        <v-divider />

        <v-card-actions>
          <v-spacer />
          <v-btn variant="text" @click="close" :disabled="loading">Cancelar</v-btn>
          <v-btn
            color="primary"
            variant="elevated"
            :disabled="!signValid || !acceptTerms || !activeCertificates.length"
            :loading="loading"
            prepend-icon="mdi-pen"
            @click="handleSign"
          >
            Assinar Documento
          </v-btn>
        </v-card-actions>
      </v-form>
    </v-card>

    <!-- Dialog de Sucesso -->
    <v-dialog v-model="successDialog" max-width="500">
      <v-card>
        <v-card-text class="text-center py-8">
          <v-icon size="64" color="success">mdi-check-circle</v-icon>
          <h2 class="text-h5 mt-4">Documento Assinado com Sucesso!</h2>
          <p class="text-body-1 mt-2">
            Sua assinatura digital foi aplicada ao documento.
          </p>
          <v-btn color="primary" variant="elevated" class="mt-4" @click="closeSuccess">
            OK
          </v-btn>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-dialog>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useSignaturesStore } from '../stores/signatures'

const props = defineProps({
  modelValue: Boolean,
  attachment: Object,
  stepExecutionId: String,
  stepName: String,
  requirement: Object
})

const emit = defineEmits(['update:modelValue', 'signed', 'upload-certificate'])

const signaturesStore = useSignaturesStore()

const signValid = ref(false)
const acceptTerms = ref(false)
const successDialog = ref(false)

const signData = ref({
  attachmentId: '',
  stepExecutionId: '',
  certificateId: null,
  certificatePassword: '',
  reason: '',
  location: '',
  contactInfo: ''
})

const loading = computed(() => signaturesStore.loading)
const activeCertificates = computed(() => signaturesStore.activeCertificates)

watch(() => props.modelValue, async (newVal) => {
  if (newVal) {
    // Carregar certificados
    await signaturesStore.fetchMyCertificates()

    // Resetar form
    signData.value = {
      attachmentId: props.attachment?.id || '',
      stepExecutionId: props.stepExecutionId || '',
      certificateId: signaturesStore.defaultCertificate?.id || null,
      certificatePassword: '',
      reason: props.requirement?.description || '',
      location: '',
      contactInfo: ''
    }
    acceptTerms.value = false
  }
})

function getCertificateColor(cert) {
  if (cert.daysUntilExpiration <= 30) return 'warning'
  return 'success'
}

function formatExpirationDate(cert) {
  const days = cert.daysUntilExpiration
  if (days <= 0) return 'Expirado'
  if (days <= 30) return `Expira em ${days} dias`
  return new Date(cert.validTo).toLocaleDateString('pt-BR')
}

function formatFileSize(bytes) {
  if (!bytes) return 'N/A'
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`
  return `${(bytes / (1024 * 1024)).toFixed(2)} MB`
}

async function handleSign() {
  if (!signValid.value || !acceptTerms.value) return

  try {
    const result = await signaturesStore.signDocument(signData.value)
    successDialog.value = true
  } catch (error) {
    console.error('Erro ao assinar:', error)
  }
}

function close() {
  emit('update:modelValue', false)
}

function closeSuccess() {
  successDialog.value = false
  emit('signed')
  close()
}
</script>
